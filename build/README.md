
# How to

## Prerequisites

You have created public/private key and uploaded public key to Google Cloud,  location and named as:

~/.ssh/gcloud_id_rsa.pub  
~/.ssh/gcloud_id_rsa  

(https://cloud.google.com/compute/docs/instances/connecting-to-instance_)


## Capture Config and store as Key Value

### Complete Web form

```
Google form: https://goo.gl/forms/z0SkkVqDKi20hepD3
```

### Download config data

```
https://docs.google.com/forms/d/11C0d5H3fxNy7h-zWQLybIPe8psoEE8Ityo-AjDmhy4Y/edit#responses
```

## Extract build Config

### Create build variables

Run from **GCP-Terraform-POC/build**

```
python util/read-gform.py
```

**Project ID** = GCP Project ID  
**File Path** = Full path and filename to CSV from Google Forms  

**Example CSV** can be found in exampleCSV folder

This python script creates a variables.tf


## Terraform

### plan

The terraform plan command is used to create an execution plan. Terraform performs a refresh, unless explicitly disabled, and then determines what actions are necessary to achieve the desired state specified in the configuration files. The plan can be saved using -out, and then provided to terraform apply to ensure only the pre-planned actions are executed.

```
terraform plan -out customer.plan
```

### apply

The terraform apply command is used to apply the changes required to reach the desired state of the configuration, or the pre-determined set of actions generated by a terraform plan execution plan.


```
terraform apply customer.plan
```

# File(s) Overview

## variables.tf

This file is created by the python script located in **util/read-gform.py**
These variables are consumed by providers.tf, asg.tf and global.tf

## providers.tf

File contains variables to authentciate, set project and region

credentials = "${file("~/.gcloud/auth.json")}" - Location of authentication provided from Google
project     = "${var.poc-project}" - Existing Project ID
region      = "${var.poc-region}" - Default region of project

## global.tf

This contains the resources to build a VPC and sets up some global inbound firewall rules for the project

## asg.tf

Contains the Google resources to build:

- A Subnet
- Load Balancer
  - health check
- Autoscale Group and policy
- Web instances
- Deploy small web app
- Allow port 80

## output.tf

Not yet used

Terraform stores hundreds or thousands of attribute values for all your resources. But as a user of Terraform, you may only be interested in a few values of importance, such as a load balancer IP, VPN address, etc.

Outputs are a way to tell Terraform what data is important. This data is outputted when apply is called, and can be queried using the terraform output command.


## customer.plan

Contains the current execution plan based off the above Terraform templates. Ensures only the pre-planned actions are executed.


## util/read-gform.py

Python script that reads the csv produced by Google forms, extracts the values and created `variables.tf` to be used by Terraform
